#!/usr/bin/env bash

# Name      : BS Interpreter
# Purpose   : Interpret brainfuck code.
# Author    : Jore <https://github.com/jorexdeveloper>

declare -a MEMORY
MAX_MEMORY=30000
POINTER=0

# Increment value at pointer
inc() {
	((MEMORY[POINTER]++))
}

# Decrement value at pointer
dec() {
	((MEMORY[POINTER]--))
}

# Move pointer right
mor() {
	((POINTER++))
	! ((POINTER < ${#MEMORY[@]})) && exp
}

# Move pointer left
mol() {
	((POINTER--))
	((POINTER < 0)) && err "Negative memory pointer at line: ${lines}, char: $((chars + 1))"
}

# Output char at pointer location
cou() {
	echo -en "\x$(printf "%x" "${MEMORY[${POINTER}]}")"
}

# Input char to pointer location
cin() {
	read -rn1 -u2 MEMORY[${POINTER}]
	MEMORY[POINTER]=$(printf '%d' "'${MEMORY[${POINTER}]}")
}

# Execute brainfuck char
exe() {
	case "${1}" in
		"+") inc ;;
		"-") dec ;;
		">") mor ;;
		"<") mol ;;
		".") cou ;;
		",") cin ;;
	esac
}

# Execute brainfuck file
run() {
	if [[ ${1} && -f ${1} ]]; then
		local depth=0
		local code=""
		chars=0
		lines=0
		exp
		while read -r line || { ((chars < ${#code})) && end=1; }; do
			[[ ${line} ]] && code+=${line}
			case "${code:${chars}:1}" in
				'[') ((MEMORY[POINTER] == 0)) && ((depth++)) ;;
				']')
					if ((depth > 0)); then
						((depth--))
					elif ((MEMORY[POINTER] != 0)); then
						((chars--))
						while ((depth > 0)) || [[ "${code:${chars}:1}" != '[' ]]; do
							case "${code:${chars}:1}" in
								'[') ((depth--)) ;;
								']') ((depth++)) ;;
							esac
							((chars--))
						done
						((chars--))
					fi
					;;
				'+' | '-' | '<' | '>' | '.' | ',') ((depth == 0)) && exe "${code:${chars}:1}" ;;
			esac
			((chars++))
			[[ ! ${end} ]] && ((lines++))
			((chars == ${#code})) && break
		done <"${1}"
	else
		usage
	fi
}

# Expand memory blocks
exp() {
	if [[ "${#MEMORY[@]}" -lt "${MAX_MEMORY}" ]]; then
		for ((m = 1; m > 0; m--)); do
			MEMORY+=(0)
		done
	else
		# BUG: Chars not accurate
		err "Out of memory at: line: ${lines}, char: $((chars + 1)), addr: ${#MEMORY[@]}"
	fi
}

# Print memory blocks
prm() {
	local c=0
	local i
	for i in "${MEMORY[@]}"; do
		printf "[%3d]" "${i}"
		((c == POINTER)) && echo -n "*" || echo -n ' '
		((c++))
		! ((c % 8)) && echo
	done
}

# Print error message and exit
err() {
	echo "${1}"
	exit 1
}

usage() {
	echo "Excecute brainfuck code."
	echo "Usage: $(basename "${0}") FILE"
}

# Start
run "${@}"
