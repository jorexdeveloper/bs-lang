#!/usr/bin/env bash

# Name      : BS Compiler
# Purpose   : Compile BS code to brainfuck.
# Author    : Jore <https://github.com/jorexdeveloper>

#
# COMMANDS
#

# increment/decrement memory block
# by arg
m() {
	if [[ ${1} -gt 0 ]]; then
		for ((i = ${1}; i > 0; i--)); do
			printf '+'
		done
	elif [[ "${1}" -lt "0" ]]; then
		for ((i = ${1}; i < 0; i++)); do
			printf '-'
		done
	fi
}

# move right and increment/decrement
# memory block block by arg
rm() {
	r && m "${@}"
}

# move left and increment/decrement
# memory block block by arg
lm() {
	l && m "${@}"
}

# move pointer right arg blocks
r() {
	[[ ! ${1} ]] && set -- 1
	for ((i = ${1}; i > 0; i--)); do
		printf '>'
	done
}

# move pointer left arg blocks
l() {
	[[ ! ${1} ]] && set -- 1
	for ((i = ${1}; i > 0; i--)); do
		printf '<'
	done
}

# input character arg times
i() {
	[[ ! ${1} ]] && set -- 1
	for ((i = ${1}; i > 0; i--)); do
		printf ','
	done
}

# move right and input character arg times
ri() {
	r && i "${@}"
}

# move right and input character arg times
li() {
	l && i "${@}"
}

# print character arg times
o() {
	[[ ! ${1} ]] && set -- 1
	for ((i = ${1}; i > 0; i--)); do
		printf '.'
	done
}

# move right and print character arg
# times
ro() {
	r && o "${@}"
}

# move right and print character arg
# times
lo() {
	l && o "${@}"
}

# Start loop n times
l:() {
	[[ ! ${1} ]] && set -- 1
	for ((i = ${1}; i > 0; i--)); do
		printf '['
	done
}

# End loop n times
:l() {
	[[ ! ${1} ]] && set -- 1
	for ((i = ${1}; i > 0; i--)); do
		printf ']'
	done
}

#
# COMPILER
#

compile() {
	local wrap=80
	if [[ ${1} && -f ${1} ]]; then
		local bs bf
		for bs in "${@}"; do
			bf="${bs%.bs}.b"
			# shellcheck disable=SC1090
			echo "#!/usr/bin/env bf" >"${bf}" &&
				source "${bs}" | sed -e "s/\(.\{${wrap}\}\)/&\n/g" >>"${bf}" &&
				echo "@" >>"${bf}" &&
				chmod u+x "${bf}" &&
				echo "${bf}"
		done
	else
		usage
	fi
}

usage() {
	echo "Compile BS code."
	echo "Usage: $(basename "${0}") FILE..."
}

# Start
compile "${@}"
